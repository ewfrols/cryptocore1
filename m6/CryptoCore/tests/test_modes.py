#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Тестирование всех режимов шифрования
"""
import os
import tempfile
from cryptocore.modes import ФабрикаРежимов
from cryptocore.crypto.iv_handler import ОбработчикIV


def тест_режима(название_режима: str, требует_дополнения: bool):
    """Тестирует один режим шифрования"""
    print(f"\n{'='*60}")
    print(f"Тестирование режима: {название_режима.upper()}")
    print('='*60)
    
    ключ = "000102030405060708090a0b0c0d0e0f"
    
    # Тестовые данные
    if требует_дополнения:
        # Для режимов с дополнением
        тестовые_данные = [
            b"Hello World!",  # Меньше блока
            b"A" * 16,        # Ровно блок
            b"B" * 32,        # Два блока
            b"C" * 50,        # Больше блока
        ]
    else:
        # Для потоковых режимов (без дополнения)
        тестовые_данные = [
            b"Hello World!",  # Меньше блока
            b"A" * 16,        # Ровно блок
            b"B" * 32,        # Два блока
            b"C" * 50,        # Больше блока
            b"",              # Пустые данные
        ]
    
    все_тесты_пройдены = True
    
    try:
        режим = ФабрикаРежимов.создать_режим(название_режима, ключ)
        
        for i, данные in enumerate(тестовые_данные, 1):
            print(f"\nТест {i}: {len(данные)} байт")
            
            # Пропускаем пустые данные для ECB
            if название_режима == 'ecb' and len(data) == 0:
                print('  Пропуск: ECB не поддерживает пустые данные')
                continue
            
            try:
                # Генерируем IV для режимов кроме ECB
                iv = None
                if название_режима != 'ecb':
                    iv = ОбработчикIV.сгенерировать_iv()
                
                # Шифруем
                зашифровано = режим.зашифровать(data, iv)
                
                # Расшифровываем
                расшифровано = режим.расшифровать(зашифровано, iv)
                
                # Проверяем
                if расшифровано == data:
                    print(f'  ✓ УСПЕХ')
                else:
                    print(f"  ✗ ОШИБКА: данные не совпадают")
                    print(f"    Оригинал: {len(данные)} байт")
                    print(f"    После расшифровки: {len(расшифровано)} байт")
                    все_тесты_пройдены = False
                    
            except Exception as e:
                print(f"  ✗ ОШИБКА: {e}")
                все_тесты_пройдены = False
    
    except Exception as e:
        print(f"✗ Ошибка создания режима: {e}")
        все_тесты_пройдены = False
    
    print(f"\nРежим {название_режима.upper()}: {'✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ' if все_тесты_пройдены else '✗ ЕСТЬ ОШИБКИ'}")
    return все_тесты_пройдены


def тест_файлового_ввода_вывода():
    """Тестирует работу с файлами и IV"""
    print(f"\n{'='*60}")
    print("Тестирование файлового ввода/вывода с IV")
    print('='*60)
    
    ключ = "000102030405060708090a0b0c0d0e0f"
    тестовый_текст = b'Test data для testing work с files и IV.'
    
    # Тестируем все режимы кроме ECB
    режимы_для_теста = ['cbc', 'cfb', 'ofb', 'ctr']
    
    все_тесты_пройдены = True
    
    for режим_название in режимы_для_теста:
        print(f"\nРежим: {режим_название.upper()}")
        
        try:
            # Создаем временные файлы
            with tempfile.NamedTemporaryFile(delete=False, suffix='.txt') as f:
                входной_файл = f.name
                f.write(тестовый_текст)
            
            зашифрованный_файл = входной_файл + '.enc'
            расшифрованный_файл = входной_файл + '.dec'
            
            try:
                # Создаем режим
                режим = ФабрикаРежимов.создать_режим(режим_название, ключ)
                
                # Генерируем IV
                iv = ОбработчикIV.сгенерировать_iv()
                print(f"  IV: {iv.hex()}")
                
                # Шифруем
                зашифрованные_данные = режим.зашифровать(тестовый_текст, iv)
                
                # Добавляем IV в начало
                данные_с_iv = ОбработчикIV.добавить_iv_к_данным(iv, зашифрованные_данные)
                
                # Записываем зашифрованный файл
                with open(зашифрованный_файл, 'wb') as f:
                    f.write(data_с_iv)
                
                # Читаем зашифрованный файл
                with open(зашифрованный_файл, 'rb') as f:
                    прочитанные_data = f.read()
                
                # Извлекаем IV и data
                iv_из_файла, data_без_iv = ОбработчикIV.извлечь_iv_из_данных(прочитанные_data)
                
                # Проверяем что IV совпадает
                if iv_из_файла != iv:
                    print(f'  ✗ ОШИБКА: IV не совпадает")
                    все_тесты_пройдены = False
                    continue
                
                # Расшифровываем
                расшифрованные_данные = режим.расшифровать(данные_без_iv, iv_из_файла)
                
                # Проверяем
                if расшифрованные_данные == тестовый_текст:
                    print(f"  ✓ УСПЕХ")
                else:
                    print(f"  ✗ ОШИБКА: данные не совпадают")
                    все_тесты_пройдены = False
                    
            finally:
                # Удаляем временные файлы
                for файл in [входной_файл, зашифрованный_файл, расшифрованный_файл]:
                    if os.path.exists(файл):
                        os.remove(файл)
        
        except Exception as e:
            print(f"  ✗ ОШИБКА: {e}")
            все_тесты_пройдены = False
    
    print(f"\nФайловый ввод/вывод: {'✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ' if все_тесты_пройдены else '✗ ЕСТЬ ОШИБКИ'}")
    return все_тесты_пройдены


def main():
    print("=" * 80)
    print("ТЕСТИРОВАНИЕ РЕЖИМОВ ШИФРОВАНИЯ CRYPTOCORE (SPRINT 2)")
    print("=" * 80)
    
    # Тестируем все режимы
    режимы_для_теста = [
        ('ecb', True),   # ECB с дополнением
        ('cbc', True),   # CBC с дополнением
        ('cfb', False),  # CFB без дополнения
        ('ofb', False),  # OFB без дополнения
        ('ctr', False),  # CTR без дополнения
    ]
    
    результаты = []
    
    # Тестируем каждый режим
    for режим, требует_дополнения in режимы_для_теста:
        результат = тест_режима(режим, требует_дополнения)
        результаты.append((режим, результат))
    
    # Тестируем файловый ввод/вывод
    результат_файлы = тест_файлового_ввода_вывода()
    
    # Выводим итоги
    print(f"\n{'='*80}")
    print("ИТОГИ ТЕСТИРОВАНИЯ:")
    print('='*80)
    
    все_пройдены = True
    
    for режим, результат in результаты:
        статус = '✓ ПРОЙДЕН' if результат else '✗ НЕ ПРОЙДЕН'
        print(f"  {режим.upper():6} : {статус}")
        if not результат:
            все_пройдены = False
    
    статус_файлы = '✓ ПРОЙДЕН' if результат_файлы else '✗ НЕ ПРОЙДЕН'
    print(f"  ФАЙЛЫ  : {статус_файлы}")
    
    print(f"\n{'='*80}")
    if все_пройдены and результат_файлы:
        print("✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!")
        return 0
    else:
        print("✗ НЕКОТОРЫЕ ТЕСТЫ НЕ ПРОЙДЕНЫ")
        return 1


if __name__ == "__main__":
    exit(main())