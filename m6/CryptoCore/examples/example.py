#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ПРИМЕР ИСПОЛЬЗОВАНИЯ CRYPTOCORE
Создаст тестовые файлы и покажет как работать с программой
"""
import os
import subprocess
import sys


def создать_тестовый_файл(имя_файла, содержимое):
    """Создает файл с заданным содержимым"""
    with open(имя_файла, 'w', encoding='utf-8') as f:
        f.write(содержимое)
    print(f"Создан файл: {имя_файла}")
    return имя_файла


def запустить_команду(команда, описание):
    """Запускает команду и показывает что происходит"""
    print(f"\n{описание}")
    print("-" * 60)
    print(f"Команда: {' '.join(команда)}")
    
    try:
        результат = subprocess.run(команда, capture_output=True, text=True)
        if результат.returncode == 0:
            print("✓ Успешно выполнено")
            if результат.stdout:
                print(f"Вывод: {результат.stdout[:200]}...")
        else:
            print(f"✗ Ошибка (код: {результат.returncode})")
            if результат.stderr:
                print(f"Сообщение об ошибке: {результат.stderr[:200]}")
        return результат.returncode == 0
    except Exception as e:
        print(f"✗ Исключение: {e}")
        return False


def основной_пример():
    """Основной пример работы программы"""
    print("=" * 70)
    print("ПРИМЕР ИСПОЛЬЗОВАНИЯ CRYPTOCORE")
    print("Шифрование файлов с русским текстом")
    print("=" * 70)
    
    # Ключ для шифрования (можно изменить)
    ключ = "000102030405060708090a0b0c0d0e0f"
    print(f"\nИспользуемый ключ: {ключ}")
    print("(В реальной программе используй свой случайный ключ!)")
    
    # Создаем тестовые файлы
    print("\n1. Создаем тестовые файлы...")
    
    файлы = []
    
    # Файл 1: Простой русский текст
    файл1 = "пример_русский.txt"
    создать_тестовый_файл(файл1, 
        """Привет! Это тестовый файл на русском языке.

Содержание:
1. Простой текст с русскими буквами
2. Специальные символы: !@#$%^&*()
3. Цифры: 1234567890
4. Разные регистры: ПРИВЕТ Привет привет

Конец файла.""")
    файлы.append(файл1)
    
    # Файл 2: Список
    файл2 = "список_покупок.txt"
    создать_тестовый_файл(файл2,
        """Список покупок:
===================
1. Молоко - 2 литра
2. Хлеб - 1 буханка
3. Яйца - 10 штук
4. Сыр "Российский" - 300г
5. Колбаса - 0.5кг

Всего: примерно 1500 рублей.""")
    файлы.append(файл2)
    
    # Файл 3: Длинный текст
    файл3 = "статья.txt"
    создать_тестовый_файл(файл3,
        """Криптография в современном мире

Криптография — это наука о методах обеспечения конфиденциальности, 
целостности данных, аутентификации и шифрования.

AES (Advanced Encryption Standard) — симметричный алгоритм 
блочного шифрования, принятый в качестве стандарта 
правительством США.

Режим ECB (Electronic Codebook) — самый простой режим 
шифрования, где каждый блок открытого текста шифруется 
независимо от других блоков.

ВАЖНО: Для реальной защиты данных рекомендуется использовать 
более безопасные режимы, такие как CBC или GCM.""")
    файлы.append(файл3)
    
    # Тестируем каждый файл
    for файл in файлы:
        print(f"\n\n{'='*70}")
        print(f"РАБОТА С ФАЙЛОМ: {файл}")
        print('='*70)
        
        # Шифрование
        команда_шифрования = [
            sys.executable, "-m", "src.main",
            "--algorithm", "aes",
            "--mode", "ecb",
            "--encrypt",
            "--key", ключ,
            "--input", файл
            # --output не указан, будет создан автоматически
        ]
        
        if not запустить_команду(команда_шифрования, f"2. Шифруем '{файл}':"):
            print("✗ Пропускаем этот файл из-за ошибки")
            continue
        
        зашифрованный_файл = файл + ".enc"
        
        # Расшифровка
        команда_расшифровки = [
            sys.executable, "-m", "src.main",
            "--algorithm", "aes",
            "--mode", "ecb",
            "--decrypt",
            "--key", ключ,
            "--input", зашифрованный_файл
            # --output не указан, будет создан автоматически
        ]
        
        if not запустить_команду(команда_расшифровки, f"3. Расшифровываем '{зашифрованный_файл}':"):
            continue
        
        расшифрованный_файл = зашифрованный_файл + ".dec"
        
        # Сравнение файлов
        print(f"\n4. Сравниваем оригинал и расшифрованную версию:")
        print("-" * 60)
        
        try:
            with open(файл, 'r', encoding='utf-8') as f1, \
                 open(расшифрованный_файл, 'r', encoding='utf-8') as f2:
                оригинал = f1.read()
                расшифровано = f2.read()
            
            if оригинал == расшифровано:
                print("✓ ФАЙЛЫ ИДЕНТИЧНЫ! Шифрование работает правильно.")
                print(f"  Размер оригинала: {len(оригинал)} символов")
                print(f"  Размер после расшифровки: {len(расшифровано)} символов")
                
                # Показываем часть текста для подтверждения
                print(f"\n  Первые 100 символов оригинала:")
                print("  " + оригинал[:100].replace('\n', ' '))
            else:
                print("✗ ФАЙЛЫ РАЗЛИЧАЮТСЯ! Что-то пошло не так.")
                print(f"  Длина оригинала: {len(оригинал)}")
                print(f"  Длина расшифрованного: {len(расшифровано)}")
                
        except Exception as e:
            print(f"✗ Ошибка при сравнении: {e}")
    
    # Очистка
    print(f"\n\n{'='*70}")
    print("5. Очистка временных файлов...")
    print("-" * 60)
    
    всех_файлов = файлы.copy()
    for файл in файлы:
        всех_файлов.append(файл + ".enc")
        всех_файлов.append(файл + ".enc.dec")
    
    удалено = 0
    for файл in всех_файлов:
        if os.path.exists(файл):
            try:
                os.remove(файл)
                print(f"  Удален: {файл}")
                удалено += 1
            except Exception as e:
                print(f"  Не удалось удалить {файл}: {e}")
    
    print(f"\nУдалено файлов: {удалено} из {len(всех_файлов)}")
    print("\n" + "=" * 70)
    print("ПРИМЕР ЗАВЕРШЕН!")
    print("=" * 70)


if __name__ == "__main__":
    try:
        основной_пример()
    except KeyboardInterrupt:
        print("\n\n✗ Пример прерван пользователем")
    except Exception as e:
        print(f"\n✗ Ошибка в примере: {e}")