#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Тестирование с русским текстом
"""
import os
import tempfile
from src.crypto.aes_ecb import AESECBШифрователь
from src.file_io import РаботаСФайлами


def тест_русский_текст():
    """Тестируем шифрование русских текстов"""
    print("Тест: Шифрование русского текста")
    print("-" * 40)
    
    ключ = "000102030405060708090a0b0c0d0e0f"
    
    # Разные русские тексты для теста
    русские_тексты = [
        # Простые фразы
        "Привет, мир!".encode('utf-8'),
        "Тестирование шифрования".encode('utf-8'),
        
        # Длинный текст
        """Это тестовое сообщение на русском языке.
Программа должна корректно шифровать и расшифровывать
текст с русскими буквами: а б в г д е ё ж з и й к л м н о п р с т у ф х ц ч ш щ ъ ы ь э ю я
А также заглавные: А Б В Г Д Е Ё Ж З И Й К Л М Н О П Р С Т У Ф Х Ц Ч Ш Щ Ъ Ы Ь Э Ю Я
И специальные символы: !@#$%^&*()_+-=[]{}|;:,.<>?
И цифры: 1234567890""".encode('utf-8'),
        
        # Текст с переносами строк
        """Строка 1
Строка 2
Строка 3
Последняя строка""".encode('utf-8'),
        
        # Пустая строка
        "".encode('utf-8'),
    ]
    
    шифрователь = AESECBШифрователь(ключ)
    все_тесты_пройдены = True
    
    for i, текст in enumerate(русские_тексты, 1):
        print(f"\nТест {i}: {len(текст)} байт")
        
        if len(текст) > 50:
            предпросмотр = текст[:50].decode('utf-8', errors='ignore') + "..."
        else:
            предпросмотр = текст.decode('utf-8', errors='ignore')
        print(f"  Текст: '{предпросмотр}'")
        
        try:
            # Шифруем
            зашифровано = шифрователь.зашифровать(текст)
            
            # Расшифровываем
            расшифровано = шифрователь.расшифровать(зашифровано)
            
            # Проверяем
            if расшифровано == текст:
                print(f"  ✓ УСПЕХ")
            else:
                print(f"  ✗ ОШИБКА: текст не совпадает")
                print(f"    Оригинал: {len(текст)} байт")
                print(f"    После расшифровки: {len(расшифровано)} байт")
                все_тесты_пройдены = False
                
        except Exception as e:
            print(f"  ✗ ОШИБКА: {e}")
            все_тесты_пройдены = False
    
    print("\n" + "=" * 40)
    if все_тесты_пройдены:
        print("✓ Все тесты с русским текстом пройдены!")
    else:
        print("✗ Некоторые тесты не пройдены")
    
    return все_тесты_пройдены


def тест_файлы_с_русскими_именами():
    """Тестируем файлы с русскими именами"""
    print("\n\nТест: Файлы с русскими именами")
    print("-" * 40)
    
    ключ = "000102030405060708090a0b0c0d0e0f"
    тестовый_текст = "Это файл с русским именем".encode('utf-8')
    
    try:
        # Создаем временный файл с русским именем
        with tempfile.NamedTemporaryFile(mode='wb', delete=False, suffix='_тест.txt') as f:
            имя_файла = f.name
            f.write(тестовый_текст)
        
        print(f"Создан файл: {имя_файла}")
        
        # Тестируем
        шифрователь = AESECBШифрователь(ключ)
        данные = РаботаСФайлами.прочитать_файл(имя_файла)
        
        # Шифруем и расшифровываем
        зашифровано = шифрователь.зашифровать(данные)
        расшифровано = шифрователь.расшифровать(зашифровано)
        
        if расшифровано == тестовый_текст:
            print("✓ Файл с русским именем обработан корректно")
            результат = True
        else:
            print("✗ Ошибка при обработке файла с русским именем")
            результат = False
    
    finally:
        # Удаляем временный файл
        if os.path.exists(имя_файла):
            os.unlink(имя_файла)
    
    return результат


if __name__ == "__main__":
    print("=" * 60)
    print("ИНТЕГРАЦИОННЫЕ ТЕСТЫ CRYPTOCORE")
    print("=" * 60)
    
    тест1 = тест_русский_текст()
    тест2 = тест_файлы_с_русскими_именами()
    
    print("\n" + "=" * 60)
    print("ИТОГИ ТЕСТИРОВАНИЯ:")
    print(f"  Тест русского текста: {'✓ ПРОЙДЕН' if тест1 else '✗ НЕ ПРОЙДЕН'}")
    print(f"  Тест русских имен файлов: {'✓ ПРОЙДЕН' if тест2 else '✗ НЕ ПРОЙДЕН'}")
    
    if тест1 and тест2:
        print("\n✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!")
        exit(0)
    else:
        print("\n✗ НЕКОТОРЫЕ ТЕСТЫ НЕ ПРОЙДЕНЫ")
        exit(1)