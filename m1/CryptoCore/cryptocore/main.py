#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Главный файл CryptoCore
"""
import sys

# Импорты из текущего пакета
from .cli_parser import ПарсерАргументов
from .file_io import РаботаСФайлами
from .crypto.aes_ecb import AESECBШифрователь


def main() -> None:
    """Главная функция программы"""
    print("=" * 50)
    print("CryptoCore - Шифровальщик файлов AES-128")
    print("=" * 50)
    
    try:
        # 1. Читаем аргументы командной строки
        print("\n1. Чтение аргументов...")
        аргументы = ПарсерАргументов.разобрать_аргументы()
        
        print(f"   Операция: {'ШИФРОВАНИЕ' if аргументы['операция'] == 'encrypt' else 'РАСШИФРОВКА'}")
        print(f"   Входной файл: {аргументы['вход']}")
        print(f"   Выходной файл: {аргументы['выход']}")
        
        # 2. Читаем файл
        print("\n2. Чтение файла...")
        входные_данные = РаботаСФайлами.прочитать_файл(аргументы['вход'])
        
        # 3. Создаем шифрователь
        print("\n3. Инициализация шифрователя AES-128...")
        шифрователь = AESECBШифрователь(аргументы['ключ'])
        print("   ✓ Шифрователь готов")
        
        # 4. Выполняем операцию
        print(f"\n4. Выполняем {аргументы['операция']}...")
        
        if аргументы['операция'] == 'encrypt':
            выходные_данные = шифрователь.зашифровать(входные_данные)
            print("   ✓ Шифрование завершено")
        else:
            выходные_данные = шифрователь.расшифровать(входные_данные)
            print("   ✓ Расшифровка завершено")
        
        # 5. Записываем результат
        print("\n5. Запись результата...")
        РаботаСФайлами.записать_файл(аргументы['выход'], выходные_данные)
        
        # 6. Готово!
        print("\n" + "=" * 50)
        print("✓ ВЫПОЛНЕНО УСПЕШНО!")
        print("=" * 50)
        print(f"\nИтог:")
        print(f"  Операция: {аргументы['операция']}")
        print(f"  Вход: {аргументы['вход']} ({len(входные_данные)} байт)")
        print(f"  Выход: {аргументы['выход']} ({len(выходные_данные)} байт)")
        
        # Дополнительная информация для текстовых файлов
        if аргументы['операция'] == 'decrypt' and len(выходные_данные) < 1000:
            try:
                текст = выходные_данные.decode('utf-8', errors='ignore')
                if len(текст) > 0:
                    print(f"\nПредпросмотр (первые 200 символов):")
                    print("-" * 40)
                    print(текст[:200] + ("..." if len(текст) > 200 else ""))
                    print("-" * 40)
            except:
                pass  # Не текст или ошибка декодирования
        
    except KeyboardInterrupt:
        print("\n\n✗ Операция прервана пользователем")
        sys.exit(1)
    except ValueError as e:
        print(f"\n✗ Ошибка шифрования: {e}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"\n✗ Неожиданная ошибка: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()