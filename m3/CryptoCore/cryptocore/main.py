#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Главный файл CryptoCore для Sprint 3
Добавлена поддержка автоматической генерации ключей через CSPRNG
"""
import sys
from .cli_parser import ПарсерАргументов
from .file_io import РаботаСФайлами
from .modes import ФабрикаРежимов
from cryptocore.crypto.iv_handler import ОбработчикIV
from cryptocore.crypto.csprng import generate_random_bytes


def main() -> None:
    """Главная функция программы"""
    print("=" * 60)
    print("CryptoCore - Шифрование файлов AES (Sprint 3)")
    print("Поддерживаемые режимы: ECB, CBC, CFB, OFB, CTR")
    print("Новая фича: Автоматическая генерация ключей!")
    print("=" * 60)
    
    try:
        # 1. Читаем аргументы командной строки
        print("\n1. Чтение аргументов...")
        аргументы = ПарсерАргументов.разобрать_аргументы()
        
        режим = аргументы['режим']
        операция = аргументы['операция']
        ключ_hex = аргументы['ключ']  # Может быть None для шифрования
        iv_hex = аргументы['iv']
        входной_файл = аргументы['вход']
        выходной_файл = аргументы['выход']
        
        print(f"   Режим: {режим.upper()}")
        print(f"   Операция: {'ШИФРОВАНИЕ' if операция == 'encrypt' else 'РАСШИФРОВКА'}")
        print(f"   Входной файл: {входной_файл}")
        print(f"   Выходной файл: {выходной_файл}")
        
        # ========== СПРИНТ 3: ОБРАБОТКА КЛЮЧА ==========
        сгенерированный_ключ = None
        
        if операция == 'encrypt':
            # ШИФРОВАНИЕ
            if ключ_hex is None:
                # Автоматическая генерация ключа через CSPRNG
                print("\n   Ключ не указан, генерируем случайный ключ...")
                try:
                    сгенерированный_ключ = generate_random_bytes(16)  # 16 байт = 128 бит
                    ключ = сгенерированный_ключ
                    ключ_hex = ключ.hex()
                    
                    print(f"   ✓ Сгенерирован ключ через CSPRNG: {ключ_hex}")
                    print("   ⚠️  СОХРАНИТЕ ЭТОТ КЛЮЧ! Он потребуется для расшифровки!")
                    print("   " + "-" * 50)
                except Exception as e:
                    print(f"✗ Ошибка генерации ключа: {e}", file=sys.stderr)
                    sys.exit(1)
            else:
                # Используем предоставленный ключ
                ключ = bytes.fromhex(ключ_hex)
                
                # Проверка на слабый ключ
                if ключ == b'\x00' * 16 or ключ == bytes(range(16)):
                    print("   ⚠️  ПРЕДУПРЕЖДЕНИЕ: Используемый ключ выглядит слабым!")
                    print("      Рекомендуется использовать автоматическую генерацию ключа")
                    print("      Пример: не указывайте --key при шифровании")
        
        else:
            # РАСШИФРОВКА
            if ключ_hex is None:
                print("\n✗ ОШИБКА: Для расшифровки необходимо указать ключ!")
                print("  Используйте: --key <шестнадцатеричный_ключ>")
                print("  Пример: --key a1b2c3d4e5f678901234567890abcdef")
                print("  Или: -k a1b2c3d4e5f678901234567890abcdef")
                sys.exit(1)
            
            # Используем предоставленный ключ для расшифровки
            try:
                ключ = bytes.fromhex(ключ_hex)
                print(f"   Используем ключ: {ключ_hex[:16]}...{ключ_hex[-16:]}")
            except ValueError:
                print(f"✗ ОШИБКА: Неверный формат ключа!", file=sys.stderr)
                print("  Ключ должен быть шестнадцатеричной строки (32 символа)", file=sys.stderr)
                sys.exit(1)
        
        # ========== ПРОДОЛЖЕНИЕ ОСНОВНОЙ ЛОГИКИ ==========
        
        # 2. Читаем файл
        print("\n2. Чтение файла...")
        входные_данные = РаботаСФайлами.прочитать_файл(входной_файл)
        print(f"   ✓ Прочитан файл: {входной_файл}")
        print(f"     Размер: {len(входные_данные)} байт")
        
        # 3. Обработка IV
        iv_байты = None
        
        if операция == 'encrypt':
            # ШИФРОВАНИЕ
            if режим != 'ecb':
                # Генерируем IV для всех режимов кроме ECB
                # Теперь IV тоже генерируется через CSPRNG!
                iv_байты = generate_random_bytes(16)
                print(f"   Сгенерирован IV через CSPRNG: {ОбработчикIV.преобразовать_iv_в_hex(iv_байты)}")
        else:
            # РАСШИФРОВКА
            if режим != 'ecb':
                if iv_hex:
                    # IV указан в аргументах
                    iv_байты = ОбработчикIV.преобразовать_hex_в_iv(iv_hex)
                    print(f"   Используем указанный IV: {iv_hex}")
                    данные_для_обработки = входные_данные
                else:
                    # IV читаем из файла (первые 16 байт)
                    try:
                        iv_байты, данные_для_обработки = ОбработчикIV.извлечь_iv_из_данных(входные_данные)
                        print(f"   Прочитан IV из файла: {ОбработчикIV.преобразовать_iv_в_hex(iv_байты)}")
                        print(f"   Оставшиеся данные: {len(данные_для_обработки)} байт")
                    except ValueError as e:
                        print(f"✗ Ошибка: {e}", file=sys.stderr)
                        print(f"   Для режима {режим.upper()} используйте --iv или убедитесь что файл содержит IV", file=sys.stderr)
                        sys.exit(1)
            else:
                # ECB режим - не использует IV
                данные_для_обработки = входные_данные
        
        # 4. Создаем режим шифрования
        print(f"\n3. Инициализация режима {режим.upper()}...")
        режим_шифрования = ФабрикаРежимов.создать_режим(режим, ключ)
        print("   ✓ Режим готов")
        
        # 5. Выполняем операцию
        print(f"\n4. Выполняем {операция}...")
        
        try:
            if операция == 'encrypt':
                if режим == 'ecb':
                    # ECB не использует IV
                    выходные_данные = режим_шифрования.зашифровать(входные_данные)
                else:
                    # Все остальные режимы используют IV
                    выходные_данные = режим_шифрования.зашифровать(входные_данные, iv_байты)
                    # Добавляем IV в начало данных
                    выходные_данные = ОбработчикIV.добавить_iv_к_данным(iv_байты, выходные_данные)
                
                print("   ✓ Шифрование завершено")
                
            else:  # decrypt
                if режим == 'ecb':
                    выходные_данные = режим_шифрования.расшифровать(входные_данные)
                else:
                    # Для режимов с IV используем данные без IV
                    if iv_hex:
                        # IV был указан, используем все данные
                        выходные_данные = режим_шифрования.расшифровать(входные_данные, iv_байты)
                    else:
                        # IV был в файле, используем данные без IV
                        выходные_данные = режим_шифрования.расшифровать(данные_для_обработки, iv_байты)
                
                print("   ✓ Расшифровка завершена")
                
        except ValueError as e:
            print(f"✗ Ошибка при выполнении операции: {e}", file=sys.stderr)
            sys.exit(1)
        
        # 6. Записываем результат
        print("\n5. Запись результата...")
        РаботаСФайлами.записать_файл(выходной_файл, выходные_данные)
        print(f"   ✓ Записан файл: {выходной_файл}")
        print(f"     Размер: {len(выходные_данные)} байт")
        
        # 7. Готово!
        print("\n" + "=" * 60)
        print("✓ ВЫПОЛНЕНО УСПЕШНО!")
        print("=" * 60)
        print(f"\nИтог:")
        print(f"  Режим: {режим.upper()}")
        print(f"  Операция: {операция}")
        print(f"  Вход: {входной_файл} ({len(входные_данные)} байт)")
        print(f"  Выход: {выходной_файл} ({len(выходные_данные)} байт)")
        
        # ========== ВЫВОД СГЕНЕРИРОВАННОГО КЛЮЧА (ЕСЛИ БЫЛ СГЕНЕРИРОВАН) ==========
        if сгенерированный_ключ is not None:
            print(f"  СГЕНЕРИРОВАННЫЙ КЛЮЧ: {ключ_hex}")
            print(f"  ⚠️  ⚠️  ⚠️  ВАЖНО: СОХРАНИТЕ ЭТОТ КЛЮЧ ДЛЯ РАСШИФРОВКИ!")
            print(f"  " + "=" * 50)
        
        if iv_байты and режим != 'ecb' and операция == 'encrypt':
            print(f"  IV: {ОбработчикIV.преобразовать_iv_в_hex(iv_байты)}")
            print(f"     (сохранен в начале выходного файла)")
        
        # Дополнительная информация для текстовых файлов
        if операция == 'decrypt' and len(выходные_данные) < 1000:
            try:
                текст = выходные_данные.decode('utf-8', errors='ignore')
                if len(текст) > 0:
                    print(f"\nПредпросмотр (первые 200 символов):")
                    print("-" * 40)
                    print(текст[:200] + ("..." if len(текст) > 200 else ""))
                    print("-" * 40)
            except:
                pass
        
    except KeyboardInterrupt:
        print("\n\n✗ Операция прервана пользователем")
        sys.exit(1)
    except Exception as e:
        print(f"\n✗ Неожиданная ошибка: {e}", file=sys.stderr)
        if "generate_random_bytes" in str(e):
            print("  Ошибка в модуле CSPRNG. Проверьте систему.", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()